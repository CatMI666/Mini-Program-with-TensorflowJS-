{"version":3,"file":"fetch_wechat.esm.js","sources":["../src/index.ts"],"sourcesContent":["export const TEXT_FILE_EXTS = /\\.(txt|json|html|txt|csv)/;\nexport interface GlobalWithFetch {\n  fetch: Function;\n}\nexport function parseResponse(url: string, res: wx.RequestSuccessCallbackResult) {\n  let header = res.header || {};\n  header = Object.keys(header).reduce((map: { [key: string]: string }, key) => {\n    map[key.toLowerCase()] = header[key];\n    return map;\n  }, {});\n  return {\n    ok: ((res.statusCode / 200) | 0) === 1, // 200-299\n    status: res.statusCode,\n    statusText: res.statusCode,\n    url,\n    clone: () => parseResponse(url, res),\n    text: () =>\n      Promise.resolve(\n        typeof res.data === 'string' ? res.data : JSON.stringify(res.data)\n      ),\n    json: () => {\n      if (typeof res.data === 'object') return Promise.resolve(res.data);\n      let json = {};\n      try {\n        json = JSON.parse(res.data);\n      } catch (err) {\n        console.error(err);\n      }\n      return Promise.resolve(json);\n    },\n    arrayBuffer: () => {\n      return Promise.resolve(res.data);\n    },\n    headers: {\n      keys: () => Object.keys(header),\n      entries: () => {\n        const all = [];\n        for (const key in header) {\n          if (header.hasOwnProperty(key)) {\n            all.push([key, header[key]]);\n          }\n        }\n        return all;\n      },\n      get: (n: string) => header[n.toLowerCase()],\n      has: (n: string) => n.toLowerCase() in header\n    }\n  };\n}\n\nexport function fetchFunc() {\n  // tslint:disable-next-line:no-any\n  return (url: string, options: any) => {\n    options = options || {};\n    const dataType = url.match(TEXT_FILE_EXTS) ? 'text' : 'arraybuffer';\n\n    return new Promise((resolve, reject) => {\n      wx.request({\n        url,\n        method: options.method || 'GET',\n        data: options.body,\n        header: options.headers,\n        dataType,\n        responseType: dataType,\n        success: (resp) => resolve(parseResponse(url, resp)),\n        fail: (err) => reject(err)\n      });\n    });\n  };\n}\n\nexport function setWechatFetch(debug=false) {\n  // tslint:disable-next-line:no-any\n  const typedGlobal = global as any;\n  if (typeof typedGlobal.fetch !== 'function') {\n    if (debug) {\n      console.log('setup global fetch...');\n    }\n    typedGlobal.fetch = fetchFunc();\n  }\n}\n"],"names":["TEXT_FILE_EXTS","parseResponse","url","res","header","Object","keys","reduce","map","key","toLowerCase","ok","statusCode","status","statusText","clone","text","Promise","resolve","data","JSON","stringify","json","parse","err","console","error","arrayBuffer","headers","entries","all","hasOwnProperty","push","get","n","has","fetchFunc","options","dataType","match","reject","wx","request","method","body","responseType","success","resp","fail","setWechatFetch","debug","typedGlobal","global","fetch","log"],"mappings":";;;;;;;;;;;;;;;;;;;;;IAAaA,eAAiB,4BAI9B,SAAgBC,cAAcC,EAAaC,GACzC,IAAIC,EAASD,EAAIC,WAKjB,OAJAA,EAASC,OAAOC,KAAKF,GAAQG,OAAO,SAACC,EAAgCC,GAEnE,OADAD,EAAIC,EAAIC,eAAiBN,EAAOK,GACzBD,QAGPG,GAAqC,IAA/BR,EAAIS,WAAa,IAAO,GAC9BC,OAAQV,EAAIS,WACZE,WAAYX,EAAIS,WAChBV,MACAa,MAAO,WAAM,OAAAd,cAAcC,EAAKC,IAChCa,KAAM,WACJ,OAAAC,QAAQC,QACc,iBAAbf,EAAIgB,KAAoBhB,EAAIgB,KAAOC,KAAKC,UAAUlB,EAAIgB,QAEjEG,KAAM,WACJ,GAAwB,iBAAbnB,EAAIgB,KAAmB,OAAOF,QAAQC,QAAQf,EAAIgB,MAC7D,IAAIG,KACJ,IACEA,EAAOF,KAAKG,MAAMpB,EAAIgB,MACtB,MAAOK,GACPC,QAAQC,MAAMF,GAEhB,OAAOP,QAAQC,QAAQI,IAEzBK,YAAa,WACX,OAAOV,QAAQC,QAAQf,EAAIgB,OAE7BS,SACEtB,KAAM,WAAM,OAAAD,OAAOC,KAAKF,IACxByB,QAAS,WACP,IAAMC,KACN,IAAK,IAAMrB,KAAOL,EACZA,EAAO2B,eAAetB,IACxBqB,EAAIE,MAAMvB,EAAKL,EAAOK,KAG1B,OAAOqB,GAETG,IAAK,SAACC,GAAc,OAAA9B,EAAO8B,EAAExB,gBAC7ByB,IAAK,SAACD,GAAc,OAAAA,EAAExB,gBAAiBN,KAK7C,SAAgBgC,YAEd,OAAO,SAAClC,EAAamC,GACnBA,EAAUA,MACV,IAAMC,EAAWpC,EAAIqC,MAAMvC,gBAAkB,OAAS,cAEtD,OAAO,IAAIiB,QAAQ,SAACC,EAASsB,GAC3BC,GAAGC,SACDxC,MACAyC,OAAQN,EAAQM,QAAU,MAC1BxB,KAAMkB,EAAQO,KACdxC,OAAQiC,EAAQT,QAChBU,WACAO,aAAcP,EACdQ,QAAS,SAACC,GAAS,OAAA7B,EAAQjB,cAAcC,EAAK6C,KAC9CC,KAAM,SAACxB,GAAQ,OAAAgB,EAAOhB,SAM9B,SAAgByB,eAAeC,gBAAAA,MAE7B,IAAMC,EAAcC,OACa,mBAAtBD,EAAYE,QACjBH,GACFzB,QAAQ6B,IAAI,yBAEdH,EAAYE,MAAQjB"}