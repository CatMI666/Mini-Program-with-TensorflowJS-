{"version":3,"file":"fetch_wechat.js","sources":["../src/index.ts"],"sourcesContent":["export const TEXT_FILE_EXTS = /\\.(txt|json|html|txt|csv)/;\nexport interface GlobalWithFetch {\n  fetch: Function;\n}\nexport function parseResponse(url: string, res: wx.RequestSuccessCallbackResult) {\n  let header = res.header || {};\n  header = Object.keys(header).reduce((map: { [key: string]: string }, key) => {\n    map[key.toLowerCase()] = header[key];\n    return map;\n  }, {});\n  return {\n    ok: ((res.statusCode / 200) | 0) === 1, // 200-299\n    status: res.statusCode,\n    statusText: res.statusCode,\n    url,\n    clone: () => parseResponse(url, res),\n    text: () =>\n      Promise.resolve(\n        typeof res.data === 'string' ? res.data : JSON.stringify(res.data)\n      ),\n    json: () => {\n      if (typeof res.data === 'object') return Promise.resolve(res.data);\n      let json = {};\n      try {\n        json = JSON.parse(res.data);\n      } catch (err) {\n        console.error(err);\n      }\n      return Promise.resolve(json);\n    },\n    arrayBuffer: () => {\n      return Promise.resolve(res.data);\n    },\n    headers: {\n      keys: () => Object.keys(header),\n      entries: () => {\n        const all = [];\n        for (const key in header) {\n          if (header.hasOwnProperty(key)) {\n            all.push([key, header[key]]);\n          }\n        }\n        return all;\n      },\n      get: (n: string) => header[n.toLowerCase()],\n      has: (n: string) => n.toLowerCase() in header\n    }\n  };\n}\n\nexport function fetchFunc() {\n  // tslint:disable-next-line:no-any\n  return (url: string, options: any) => {\n    options = options || {};\n    const dataType = url.match(TEXT_FILE_EXTS) ? 'text' : 'arraybuffer';\n\n    return new Promise((resolve, reject) => {\n      wx.request({\n        url,\n        method: options.method || 'GET',\n        data: options.body,\n        header: options.headers,\n        dataType,\n        responseType: dataType,\n        success: (resp) => resolve(parseResponse(url, resp)),\n        fail: (err) => reject(err)\n      });\n    });\n  };\n}\n\nexport function setWechatFetch(debug=false) {\n  // tslint:disable-next-line:no-any\n  const typedGlobal = global as any;\n  if (typeof typedGlobal.fetch !== 'function') {\n    if (debug) {\n      console.log('setup global fetch...');\n    }\n    typedGlobal.fetch = fetchFunc();\n  }\n}\n"],"names":[],"mappings":"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"}